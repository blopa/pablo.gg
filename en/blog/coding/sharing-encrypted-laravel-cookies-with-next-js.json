{"html":"<p>I often have friends asking me, “Pablo, how do you manage to stay so calm and collected in the face of complex technical challenges?” Well, the truth is, I don’t. I just write blog posts about them to make it seem like I do. This is one of those stories.</p>\n<p>I recently found myself needing to crack open the values of cookies coming from a Laravel application, read them, update them, and then patch them back up in a way the Laravel application wouldn’t even notice. Sounds like the plot of a Mission Impossible movie, right? Let’s roll with that, and I’m Tom Cruise.</p>\n<h2 id=\"the-infamous-nextjs-migration\" style=\"position:relative;\"><a href=\"#the-infamous-nextjs-migration\" aria-label=\"the infamous nextjs migration permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The infamous Next.js migration</h2>\n<p>After migrating from <a href=\"https://medium.com/studocu-techblog/migrating-from-coffeescript-to-javascript-es6-ed73bcae851e\" target=\"_blank\" rel=\"noreferrer\">CoffeeScript to ES6</a> and then from <a href=\"https://medium.com/studocu-techblog/how-we-migrated-our-codebase-to-typescript-c7962f1b877a\" target=\"_blank\" rel=\"noreferrer\">ES6 to TypeScript</a>, it was time for another major refactor: <a href=\"https://medium.com/studocu-techblog/migrating-from-a-monolith-to-next-js-at-studocu-part-1-4b0baf3d5fe9\" target=\"_blank\" rel=\"noreferrer\">detaching our frontend from Laravel into a separate Next.js app</a>.</p>\n<p>In order to improve performance, developer experience, and employer desirability (shameless plug, we’re hiring at <a href=\"https://jobs.studocu.com/job-postings\" target=\"_blank\" rel=\"noreferrer\">Studocu</a> <em>wink-wink</em>), we needed a robust frontend framework that could handle our growing user base and feature set. Next.js seemed like the perfect fit.</p>\n<p>This theoretically would help us stop reinventing the wheel - like writing endless lines of Webpack configurations - and focus on what really matters: building features that our users love. So the plan is that instead of having one spaghetti codebase, we would have two smaller, noodle-like codebases.</p>\n<p></p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 62.109375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC2klEQVQozy2SV08aAQCA79c0afpgk/ah66EacVAirjiq1lkVsYjQoETREjc2NVpNIY5KVVC0FRcOhhbkuDvAosZto3DcnbdYmva1MfX1S76XLx9whTqvUCeDu3D/dpjaIVGQRu3XFMTgEE3A2KWDDDopDGTwW8ISUIRy4ygYoT0sAQME6oyS8E94+dPU8Pz8qGG0cUJdv2zWaZd0c9ODF6c2hkSo4J3M4K5pvbpLITEMd5MoCNAYCO+ZB9QftbLi5obyPmmaouGtuDa/9f0bgzLPNtMZON1kCJhEwSjjdVj1woK80sL87NTElYUxIER7rTZDn7RALs7rFfKVTWXy2uTytEdPHj1oLubMNeT4NrQhZofFob8Rn3ltqio1sbIgu6zo9apxDMAxeFopqM1IkL98mJX4gsuJS3t+jxP/rDL9cY0of6gx+wAyxEI7GyvjR3urYdKt1fS0SqqHv/QE/U4gcLo1UZMqi48T81Mk5QmSzPuykpTu+rx2abGoKk2hFCwZ1Rbz0snx0bbDen64HqG9/hMbexsPBigC+tEvlBTymkXZnWKO8RsviHDPkazepsyeUp5UUWtaH/fCpvXVRYfdFDjfjNHuGOOOUB4ag4DAhUOl7u0SZnW/y60TF0OWjEsPd0XPaf+QI6/OHRAleZ1T12EfvG24PLNeM96FeW1Xa9Oy7jNDQACFIZrZ8WZ5iUxc2iJKt37n67WvNB1PVZLk/oqkMVVV4NTKEEiEct+Ed+wWQ5u8wDbPVdbx15YmAZZA9vctM0bNYEuFUpDRUcmTNlUo2ouE8jrdUNvZ1iQbBCkcIlHwJuRdWdR1yDLXZ7j1ggzj7AhAoCAZdOG4+9hn8pj1v5ZH3Kavc1ajFVzALu0s6SFxiMJc//ci/M4hVUtdeVGfqsX/2w5QOETjME0gYXY3Gj2Ixg5jsYM/4d3rkI8lvTSOUNidTGOu8BVCE9DJ3hqFucIk8g/70eAbl2hLKwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Spaghetti code\" title=\"Spaghetti code\" src=\"/static/63a275658d485cabf21527594c9d1a0d/42a19/spaghetti-code.png\" srcset=\"/static/63a275658d485cabf21527594c9d1a0d/e3135/spaghetti-code.png 256w,\n/static/63a275658d485cabf21527594c9d1a0d/06341/spaghetti-code.png 512w,\n/static/63a275658d485cabf21527594c9d1a0d/42a19/spaghetti-code.png 1024w,\n/static/63a275658d485cabf21527594c9d1a0d/e8464/spaghetti-code.png 1536w,\n/static/63a275658d485cabf21527594c9d1a0d/16e03/spaghetti-code.png 1651w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Spaghetti code</figcaption>\n  </figure><p></p>\n<h2 id=\"but-why\" style=\"position:relative;\"><a href=\"#but-why\" aria-label=\"but why permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>But why?</h2>\n<p>As <a href=\"https://www.grammy.com/artists/ryan-reynolds/243495\" target=\"_blank\" rel=\"noreferrer\">one-time Grammy-nominated Ryan Reynolds</a> once said: But why?</p>\n<p><img src=\"/f1547924a1c5e48fc3d7132349267d59/but-why.gif\" alt=\"Actual footage of readers of this post\"></p>\n<p>Good question! Here’s the thing: we decided that the best way to implement this transition to Next.js was to move one page at a time. This means we would have to share cookies between the Laravel and Next.js applications. While this brings lots of benefits, it also presents some unique challenges.</p>\n<p>The biggest challenge is that Laravel and Next.js don’t exactly speak the same language when it comes to cookie encryption. Laravel uses its own encryption algorithm and, by default, encrypts every cookie using a private key. Without this key, and without reverse-engineering Laravel’s algorithm, it’s impossible to read the data on the Next.js side.</p>\n<p>On the other hand, Next.js is quite unopinionated about how you store your cookies. Since we were spinning up a new Next.js application from scratch, this was a perfect opportunity to align it with Laravel’s encryption method, allowing us to freely decrypt and encrypt Laravel’s cookies directly in Next.js without risking breaking anything.</p>\n<h2 id=\"diving-into-laravels-cookie-encryption\" style=\"position:relative;\"><a href=\"#diving-into-laravels-cookie-encryption\" aria-label=\"diving into laravels cookie encryption permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Diving into Laravel’s cookie encryption</h2>\n<p>Before we could solve this problem, we needed to understand how Laravel encrypts its cookies. Turns out, there isn’t a whole lot of information out there about this. In an age where it’s hard to find something unique to write a blog post about, I thought this would be the perfect opportunity to share some insights.</p>\n<p>So, how do we figure out how Laravel encrypts its cookies? By diving into <a href=\"https://github.com/laravel/laravel\" target=\"_blank\" rel=\"noreferrer\">the source code</a>, of course! Fortunately, Laravel’s source code is quite readable and well-organized, so it didn’t take long to track down the relevant parts.</p>\n<h3 id=\"application-key\" style=\"position:relative;\"><a href=\"#application-key\" aria-label=\"application key permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Application Key</h3>\n<p>Laravel uses a private key, known as the Application Key, for encryption, which can be generated using the <code class=\"language-text\">php artisan key:generate</code> command. It employs a <code class=\"language-text\">AES-256-CBC</code> cipher for encryption, which requires an Initialization Vector (IV). Additionally, Laravel uses a Message Authentication Code (MAC) to ensure the integrity of the encrypted data.</p>\n<h3 id=\"initialization-vector\" style=\"position:relative;\"><a href=\"#initialization-vector\" aria-label=\"initialization vector permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Initialization Vector</h3>\n<p>The IV is a random value that’s used to ensure that the same plaintext doesn’t encrypt to the same ciphertext. Laravel generates a random IV for each cookie and stores it alongside the encrypted value.</p>\n<h3 id=\"message-authentication-code\" style=\"position:relative;\"><a href=\"#message-authentication-code\" aria-label=\"message authentication code permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Message Authentication Code</h3>\n<p>The MAC is a cryptographic checksum that ensures the integrity of the encrypted data. Laravel generates a MAC using the IV and the encrypted value, which is then used to verify the integrity of the data during decryption.</p>\n<h3 id=\"flow-chart\" style=\"position:relative;\"><a href=\"#flow-chart\" aria-label=\"flow chart permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Flow chart</h3>\n<p></p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 125.78125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsTAAALEwEAmpwYAAADFElEQVQ4y32UaXLjNhCFdf87JZUcIDWxtVnyjCURXEDsK7ETKYoux47tdOFHE4UPeHjdxCbGTEl4G4R4Qjwl4fICz+cGAMpYIth3rcTIMRoJDoL7Wuda68ZNwdrgfHIueZ9jLCnNIWSlLCFccK2Vm2y8vAAprPfZ+aSVK6UssHdxzWqtpRRjHEIUY2aMu8/N6yHv4w35ALspHvftw8Nt+9i8/MLvgXmev4J9LLkoZaQ0IyJau/vSGkJMKdWv4gOcU1Fq6jqEEPc+rvpLKdZOKaW8pPO3cAz55xnt9+Bw6Eeoaq1aW4Q5hIRQiTCfJv81HEKS3FJi4MAxUpxZJScplkGJFMxIYZV0hAjBjVaOEMmZXh3Y1FpzLhgzOJChR1KZea4551LmEOJdc5nn2Vob43Kj+13yKmFjTXRTljIgpBi1xsTJJmOWsmO01Nm5bE3i3GoVrEmCT0r5Jbdxg5E9PeH9Dv79o9lt+90Wdq3Go3v4AX7/7a8//3jcbQdKPEaGUi94RKOh1AkeCbZLh8FBXC/4dsXXK75csNE+xtzcSHOjLeAA0JxLzmk1KaU03xM3hQWutQqhR8QI4c4tnzEmzvUICWNqRAyOrO9x32NCZIyvVi+wd6GUGY3qeh1bQJRya50ZNdcLBIAIbnPOzvkYUynzJzjPlxd8Orbn00CwXp0cOvF0bJ+OLRrVXcsr8x84xpgYVRhzgrkQ2loHIcWYjyOlVAlhKJXWTuumKaW14RY4+OhcGAZ2vfQAIIxkStm54H2kVN2usAWo78gImZuiMY4xuR6wwDEkzqfjoTsdu8MBPJ/gWye3Ddtvm/2uOezA40MzDlLrCWNOiZDKOnuXnXJmTGMsKFNK2fpNrC35QfYCp0yIbBo4QCrld/CrnBDeGRZ8tCY+n8fn5/F8hqDhn16OD/GF2+Mouo70HaFU/Q9ZSgkhrK/KK1xKkdIoZYXQQupwj6Ul8lyWxpxzLinGdT7ntzfrDn/lTWkBWUrw1G+3txbQz2sWmBEthRX833H/+yeMFGhoBxi4ETgIKezbsjXnVP8DzmSYeSssc+sAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Encryption flow\" title=\"Encryption flow\" src=\"/static/983add2af1440049060bb0a9e7534d24/242a6/encryption-flow.png\" srcset=\"/static/983add2af1440049060bb0a9e7534d24/e3135/encryption-flow.png 256w,\n/static/983add2af1440049060bb0a9e7534d24/06341/encryption-flow.png 512w,\n/static/983add2af1440049060bb0a9e7534d24/242a6/encryption-flow.png 720w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Encryption flow</figcaption>\n  </figure><p></p>\n<p>All of this might change depending on your version of Laravel or how much you’ve customized your encryption settings. You can check your <code class=\"language-text\">config/app.php</code> file to see how your encryption settings are configured.</p>\n<p>Here’s a simplified breakdown of the process:</p>\n<ol>\n<li><strong>Cookie Value</strong>: The cookie value is stringified and then <a href=\"https://github.com/illuminate/cookie/blob/v9.52.16/Middleware/EncryptCookies.php#L180\" target=\"_blank\" rel=\"noreferrer\">prefixed</a> with <a href=\"https://github.com/illuminate/cookie/blob/v9.52.16/CookieValuePrefix.php#L14\" target=\"_blank\" rel=\"noreferrer\">a <code class=\"language-text\">SHA-1</code> hash</a> based on the cookie name and a version string (<code class=\"language-text\">\"v2\"</code>).</li>\n<li><strong>Encryption</strong>: The prefixed value is <a href=\"https://github.com/illuminate/encryption/blob/v9.52.16/Encrypter.php#L102\" target=\"_blank\" rel=\"noreferrer\">encrypted using <code class=\"language-text\">AES-256-CBC</code></a>.</li>\n<li><strong>MAC Generation</strong>: A MAC is <a href=\"https://github.com/illuminate/encryption/blob/v9.52.16/Encrypter.php#L116\" target=\"_blank\" rel=\"noreferrer\">generated using <code class=\"language-text\">HMAC-SHA256</code></a> over the IV and the encrypted value.</li>\n<li><strong>Payload Assembly</strong>: The encrypted value, IV, MAC, and a tag are <a href=\"https://github.com/illuminate/encryption/blob/v9.52.16/Encrypter.php#L118\" target=\"_blank\" rel=\"noreferrer\">assembled into a JSON object</a>.</li>\n<li><strong>Base64 Encoding</strong>: This JSON object is <a href=\"https://github.com/illuminate/encryption/blob/v9.52.16/Encrypter.php#L124\" target=\"_blank\" rel=\"noreferrer\">then base64-encoded</a> to form the final cookie value.</li>\n</ol>\n<p>An example of the encrypted cookie structure looks like this:</p>\n<div class=\"copy-code-block\"><button tabindex=\"0\" type=\"button\" class=\"MuiButtonBase-root MuiButton-root MuiButton-contained MuiButton-containedPrimary copy-code-button\"><span class=\"MuiButton-label\">Copy</span></button><div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"encryptedValue\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iv\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"base64-encoded-IV\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"mac\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hex-encoded-MAC\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"tag\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"base64-encoded-tag\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div></div>\n<p>Understanding this structure was crucial for replicating the encryption and decryption processes in Next.js.</p>\n<h2 id=\"recreating-laravels-encryption-in-nextjs\" style=\"position:relative;\"><a href=\"#recreating-laravels-encryption-in-nextjs\" aria-label=\"recreating laravels encryption in nextjs permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recreating Laravel’s encryption in Next.js</h2>\n<p>To read and update Laravel’s encrypted cookies in Next.js, we needed to replicate Laravel’s encryption logic in our Next.js application. Here’s how we tackled it.</p>\n<p></p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 59.765625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC3UlEQVQozxXL308ScQAA8Psr2npz/bJpreyH2q9hyx9wd0CSoHjC3XH3BQ6OAw+OXxmRlGmOQhIQ0APlN0pLg3KmM1ur9dJbaytb8ZJP/QO91Pq8fyC5xq0c8dzUelSjHg3uR4d9Y0woOJ9TYZ6z7YMRmE4N4EtSIgPjqX6wJDUUEaKEGCoyuioHUOPz/vb+z90fzb1m893Br616WqGiDh3uVo0KnR2aKAxEmMjAhCgjS8OyZYU6D1PVQWLNrM2Y+qHNL1+397/vfNt/f3BQ/7Bbs593ciw9EbN6w51n1TEUZBGyIDeIUpBRn8wOSrJ9TEmnWZ9DM8I1KFGrxyrrydWNaOWF6EJqVEtjFvv4qTEdFzvPDCfkdBbV5VCQ6pO/nXT8rs7UMUVFi72K3ix4eiAEpbvOKSWXhs533ArqYJGXRTzE8zgXTiQvX8TmUUNed2OLvb7KSKqT5NpDU21cvqbXvo6rVwO9kFzBtLUOtB7raT0JL5glz6zt8Vyp+fdPafdNd8dQQgEKSqI0hBVUIK5S7fhPbwZubExpn02rF6yXIRlCt7T0oNbolatDM+q2qP5i8j4XiK2TlqleCZVGiDJKFlFDVmps0PAH34kNn+Tl/GjU1D2Ln4OkSueRo73I+KJWKguaDSO28j2gIZg4xRctwsptespvnHGzMS9mWdYdLzMXyncG9xLqNNcVxk9BmFXsRd1tHViYlPi9c6RvMyqACd8T4HtucucId55058ZcxfS4gjcLSU7pdYUioYmIQ/mA6odwm0jyVZM99tBpM/AFgq94nVMBG4c78hQvElyK5JIYK5ZcCMs9mrVhd3mf1lGx+gtWfxHCuQzO5Yy2GMM9NTiLtLMAhIrRuUI5lnFuUc+m9OyC1rL4xI5ZmeAjjgzZLaNcluaXgLAC0f9DHrirwFMzCkWju2QUysBVofkcaU/r2aSeW9SRoYCZALbHDDttYmf1bIp0pCln9h8Xf01Zd5UGBgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Same cookies\" title=\"Same cookies\" src=\"/static/ff0e8bf793eed9722337c7730b832247/42a19/same-cookies.png\" srcset=\"/static/ff0e8bf793eed9722337c7730b832247/e3135/same-cookies.png 256w,\n/static/ff0e8bf793eed9722337c7730b832247/06341/same-cookies.png 512w,\n/static/ff0e8bf793eed9722337c7730b832247/42a19/same-cookies.png 1024w,\n/static/ff0e8bf793eed9722337c7730b832247/e8464/same-cookies.png 1536w,\n/static/ff0e8bf793eed9722337c7730b832247/2eb59/same-cookies.png 2048w,\n/static/ff0e8bf793eed9722337c7730b832247/5cc60/same-cookies.png 2444w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Same cookies</figcaption>\n  </figure><p></p>\n<h3 id=\"decrypting-cookies\" style=\"position:relative;\"><a href=\"#decrypting-cookies\" aria-label=\"decrypting cookies permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Decrypting cookies</h3>\n<p>We created a function <code class=\"language-text\">decryptCookieValue</code> that mirrors Laravel’s decryption process. Here’s a simplified version:</p>\n<div class=\"copy-code-block\"><button tabindex=\"1\" type=\"button\" class=\"MuiButtonBase-root MuiButton-root MuiButton-contained MuiButton-containedPrimary copy-code-button\"><span class=\"MuiButton-label\">Copy</span></button><div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">decryptCookieValue</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">encryptedCookieValue</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> publicKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">APP_KEY</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> encoder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> decoder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Decode and parse the cookie</span>\n  <span class=\"token keyword\">const</span> decodedResult <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>encryptedCookieValue<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> parsedResult <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>decodedResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> iv<span class=\"token punctuation\">,</span> mac<span class=\"token punctuation\">,</span> value <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> parsedResult<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Verify the MAC</span>\n  <span class=\"token keyword\">const</span> macPayload <span class=\"token operator\">=</span> iv <span class=\"token operator\">+</span> value<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> keyMaterial <span class=\"token operator\">=</span> encoder<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>publicKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> hmacKey <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">importKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">'raw'</span><span class=\"token punctuation\">,</span> keyMaterial<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'HMAC'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">hash</span><span class=\"token operator\">:</span> <span class=\"token string\">'SHA-256'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'verify'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> isMacValid <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span><span class=\"token string\">'HMAC'</span><span class=\"token punctuation\">,</span> hmacKey<span class=\"token punctuation\">,</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>mac<span class=\"token punctuation\">,</span> <span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> encoder<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>macPayload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isMacValid<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'MAC validation failed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Decrypt the value</span>\n  <span class=\"token keyword\">const</span> ivArray <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>iv<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> encryptedData <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> cryptoKey <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">importKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">'raw'</span><span class=\"token punctuation\">,</span> keyMaterial<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'AES-CBC'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'decrypt'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> decryptedData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">decrypt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'AES-CBC'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">iv</span><span class=\"token operator\">:</span> ivArray <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cryptoKey<span class=\"token punctuation\">,</span> encryptedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> decryptedString <span class=\"token operator\">=</span> decoder<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>decryptedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Remove Laravel's cookie prefix</span>\n  <span class=\"token keyword\">return</span> decryptedString<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">41</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div></div>\n<p>This function decrypts the cookie value, verifies the MAC, and returns the decrypted string. We also had to remove Laravel’s cookie prefix with a <code class=\"language-text\">slice</code> - pretty much how it’s done in the <a href=\"https://github.com/illuminate/cookie/blob/v9.52.16/CookieValuePrefix.php#L27\" target=\"_blank\" rel=\"noreferrer\">original code</a> - to get the original cookie value.</p>\n<h3 id=\"encrypting-cookies\" style=\"position:relative;\"><a href=\"#encrypting-cookies\" aria-label=\"encrypting cookies permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Encrypting cookies</h3>\n<p>We also needed to encrypt cookies in Next.js so that Laravel could understand. Here’s the <code class=\"language-text\">encryptCookieValue</code> function:</p>\n<div class=\"copy-code-block\"><button tabindex=\"2\" type=\"button\" class=\"MuiButtonBase-root MuiButton-root MuiButton-contained MuiButton-containedPrimary copy-code-button\"><span class=\"MuiButton-label\">Copy</span></button><div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">encryptCookieValue</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">cookieName<span class=\"token punctuation\">,</span> value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> publicKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">APP_KEY</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> encoder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Create the Laravel cookie prefix</span>\n  <span class=\"token keyword\">const</span> cookiePrefix <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">createLaravelCookiePrefix</span><span class=\"token punctuation\">(</span>cookieName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> prefixedValue <span class=\"token operator\">=</span> cookiePrefix <span class=\"token operator\">+</span> value<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Generate a random IV</span>\n  <span class=\"token keyword\">const</span> iv <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">getRandomValues</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> keyMaterial <span class=\"token operator\">=</span> encoder<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>publicKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Encrypt the value</span>\n  <span class=\"token keyword\">const</span> cryptoKey <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">importKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">'raw'</span><span class=\"token punctuation\">,</span> keyMaterial<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'AES-CBC'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'encrypt'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> encryptedData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">encrypt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'AES-CBC'</span><span class=\"token punctuation\">,</span> iv <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cryptoKey<span class=\"token punctuation\">,</span> encoder<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>prefixedValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Generate the MAC</span>\n  <span class=\"token keyword\">const</span> encryptedBase64 <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>encryptedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> ivBase64 <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>iv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> macPayload <span class=\"token operator\">=</span> ivBase64 <span class=\"token operator\">+</span> encryptedBase64<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> hmacKey <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">importKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">'raw'</span><span class=\"token punctuation\">,</span> keyMaterial<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'HMAC'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">hash</span><span class=\"token operator\">:</span> <span class=\"token string\">'SHA-256'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sign'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> macData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token string\">'HMAC'</span><span class=\"token punctuation\">,</span> hmacKey<span class=\"token punctuation\">,</span> encoder<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>macPayload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> macHex <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>macData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Assemble the payload</span>\n  <span class=\"token keyword\">return</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>\n    <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">iv</span><span class=\"token operator\">:</span> ivBase64<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">mac</span><span class=\"token operator\">:</span> macHex<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">tag</span><span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> encryptedBase64<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div></div>\n<p>This function encrypts the cookie value, generates a MAC, and assembles the encrypted cookie payload.</p>\n<p>And here’s the helper function to create the Laravel cookie prefix:</p>\n<div class=\"copy-code-block\"><button tabindex=\"3\" type=\"button\" class=\"MuiButtonBase-root MuiButton-root MuiButton-contained MuiButton-containedPrimary copy-code-button\"><span class=\"MuiButton-label\">Copy</span></button><div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createLaravelCookiePrefix</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">cookieName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> publicKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">APP_KEY</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> encoder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> encoder<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>cookieName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">v2</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> encoder<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>publicKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> cryptoKey <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">importKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">'raw'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'HMAC'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">hash</span><span class=\"token operator\">:</span> <span class=\"token string\">'SHA-1'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sign'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> signature <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> crypto<span class=\"token punctuation\">.</span>subtle<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token string\">'HMAC'</span><span class=\"token punctuation\">,</span> cryptoKey<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> hexSignature <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>hexSignature<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">|</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div></div>\n<p>These functions ensure that cookies encrypted in Next.js can be decrypted by Laravel, allowing for seamless cross-framework integration.</p>\n<h2 id=\"challenges-and-security-considerations\" style=\"position:relative;\"><a href=\"#challenges-and-security-considerations\" aria-label=\"challenges and security considerations permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Challenges and security considerations</h2>\n<p>Of course, this process wasn’t without its hurdles:</p>\n<ul>\n<li><strong>Cryptographic compatibility</strong>: Matching Laravel’s encryption in Node.js requires careful handling of encoding, data types, and cryptographic functions.</li>\n<li><strong>Environment constraints</strong>: We had to ensure that these functions only run on the server side, as they rely on server-side environment variables and cryptography APIs.</li>\n<li><strong>Security considerations</strong>: We took extra care to ensure that the <code class=\"language-text\">APP_KEY</code> remains secure and never exposed to the client side. Error handling, MAC verification, and ensuring the IV is unique for each encryption were key to preventing security vulnerabilities.</li>\n<li><strong>Testing and debugging</strong>: Verifying that our encryption and decryption matched Laravel’s required a lot of trial and error, and a deep understanding of both frameworks.</li>\n<li><strong>Deciding which cookies to encrypt</strong>: Not all cookies needed encryption, so we carefully selected only the ones that handle sensitive data.</li>\n</ul>\n<p>It’s also worth noting that this solution is specific to our use case and may not be suitable for all scenarios. It’s essential to understand the security implications of replicating encryption mechanisms and ensure that your implementation is secure and compliant with best practices.</p>\n<h2 id=\"the-payoff-a-seamless-user-experience\" style=\"position:relative;\"><a href=\"#the-payoff-a-seamless-user-experience\" aria-label=\"the payoff a seamless user experience permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The payoff: A seamless user experience</h2>\n<p></p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 57.03125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACqklEQVQozwGfAmD9ADcgLDslMUArOEA3RUhdcniitnKZrD1FVzgtPDUiMTEXJjsnM0AyP0Y/S0NJWUNQYT88SkU2QkQwOz0lMgA+JzRBLTpDPkxObIKEuc2isrGXrLJdh6I8T2NAR1g6NEM/PEpETFxMZHdrmbCHvtRnkalNW2xMQUxCLzoAPy06RTxIS2F0V3WLdIyZqrq3u8W1sLCOV2lzSm6IP0xdQldqTW2DZZCokMDSeIyQgJ6pYYeeT1ZkUVppAEE0QURFU1d7kVxwhDEcK2NXVZ2GZIJpU2h/ik53lGCIn22fuWSOpm6NoYCVmyoiH0dGRIiuvG+dtGiVrQBCPElFUGFZfZRecIM9PFBKQ0xtXVtkYGeFmZiIr7trmrNTdY5ka26glna10cijv8SNp6x4g4iCp7ZcZnMAPjtJRFdpRlVqMh0uMR8vU0pMgo2NjbbCi5WMiIRvPF96NEtlWVlcpb64qdzquuHerrGVRS0xUj9EPicyADw5SD1IWTtPZEhJVXaAgqbNzanPzJWimHyPkENddEpZZH+LhZC5xIe2xIOYml1aXV9SSTwkLT4sOkQwPAAxHitDQ09xkJuQwM6Wx9ODk5NvdXVZbX5OZHiFkoiuxbanwbysv6+KhnZ6ipBZdIksK0Q2ITFGOEVBLToAUl1sgq27fqm5cYuXXmBnXGh1UWR2aXFyk6Wfqs/MosG8gHVjeHd0aYibYIqjUG2CPDxONSAuPCo4OiU0AGySpllrek9TX09VZVFcblhganV8fJe+xIy4xHBycHFrZGyDkWmTq1Z4jk1qgURXazUxQjEYKDchMDUeLQBGRFRHRVVTYXI5NUdHVGVzlqZqkaZXa31LSFNdbHlcdYpUcIRJYHVIW3BBUGQ7P1E0JzcsECEwFiYuEiHJohHl9BsUMQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Fully integrated\" title=\"Fully integrated\" src=\"/static/b78488b37ae488bb5c43e5ec64293b2c/42a19/fully-integrated.png\" srcset=\"/static/b78488b37ae488bb5c43e5ec64293b2c/e3135/fully-integrated.png 256w,\n/static/b78488b37ae488bb5c43e5ec64293b2c/06341/fully-integrated.png 512w,\n/static/b78488b37ae488bb5c43e5ec64293b2c/42a19/fully-integrated.png 1024w,\n/static/b78488b37ae488bb5c43e5ec64293b2c/e8464/fully-integrated.png 1536w,\n/static/b78488b37ae488bb5c43e5ec64293b2c/445c6/fully-integrated.png 1792w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Fully integrated</figcaption>\n  </figure><p></p>\n<p>By replicating Laravel’s encryption mechanisms in Next.js, we achieved a seamless user experience. Users can navigate between Laravel and Next.js pages without any hiccups, and their session data remains consistent throughout. Honestly, it’s quite impressive how seamlessly the whole flow works without users even noticing the transition between the two frameworks.</p>\n<p>This solution also opens up new possibilities for integrating other platforms with Laravel, as long as they can replicate Laravel’s encryption process. It’s a testament to the power of understanding and adapting complex systems to achieve interoperability.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"post-headers-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p><img src=\"/1f382bda4eb7e36eb31460d035a5a8d3/cookie-crumbles.gif\" alt=\"That's the way the cookie crumbles\"></p>\n<p>Integrating cookies between two different frameworks and programming languages isn’t exactly a walk in the park - unless the park is Central Park, and you’re <a href=\"https://www.youtube.com/watch?v=vm-471akcQU\" target=\"_blank\" rel=\"noreferrer\">John Wick right after being excommunicado</a>. But with a deep dive into how each framework handles encryption and a fair bit of perseverance (and maybe some <a href=\"https://en.wikipedia.org/wiki/Mate_(drink)\" target=\"_blank\" rel=\"noreferrer\">mate</a>), it’s definitely doable.</p>\n<p>I hope this explanation sheds some light on how to tackle such a challenge. If you find this kind of problem-solving exciting, maybe you’d like to join us. We’re always on the lookout for talented individuals - check out our <a href=\"https://jobs.studocu.com/job-postings\" target=\"_blank\" rel=\"noreferrer\">job openings</a>. I know I might have made it sound like a nightmare, but trust me, it’s the fun kind!</p>\n<p>Happy coding!</p>","path":"/en/blog/coding/sharing-encrypted-laravel-cookies-with-next-js/","title":"Sharing encrypted Laravel cookies with Next.js","language":"en","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDI0LTEwLTI1VDAwOjAwOjAwLjAwMFo=","comments":[],"relatedPosts":[{"path":"/en/blog/coding/tracking-my-working-hours-on-personal-projects-ssing-nodejs/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDI0LTA2LTE2VDAwOjAwOjAwLjAwMFo=","title":"Tracking my working hours on personal projects using Node.js","date":"2024-06-16T00:00:00.000Z"},{"path":"/en/blog/coding/creating-instagram-reels-coding-tutorials-automatically-with-openais-gpt/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDIzLTEyLTIwVDAwOjAwOjAwLjAwMFo=","title":"Creating Instagram Reels coding tutorials automatically with OpenAI's GPT","date":"2023-12-20T00:00:00.000Z"},{"path":"/en/blog/coding/how-to-automatically-create-thumbnails-for-your-videos-with-nodejs/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDIzLTEwLTI1VDAwOjAwOjAwLjAwMFo=","title":"How to automatically create thumbnails for your videos with Node.js","date":"2023-10-25T00:00:00.000Z"},{"path":"/en/blog/coding/posting-instagram-reels-using-nodejs-and-the-art-of-overcoming-limitations/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDIzLTEwLTE0VDAwOjAwOjAwLjAwMFo=","title":"Posting Instagram Reels using Node.js and the art of overcoming limitations","date":"2023-10-14T00:00:00.000Z"},{"path":"/en/blog/coding/my-blog-now-has-stories-and-im-not-sure-why/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDIzLTA5LTA0VDAwOjAwOjAwLjAwMFo=","title":"My blog now has Stories, and I'm not sure why","date":"2023-09-04T00:00:00.000Z"},{"path":"/en/blog/coding/using-google-fitness-api-to-calculate-my-tdee-and-more/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDIzLTA4LTAyVDAwOjAwOjAwLjAwMFo=","title":"Using Google Fitness API to calculate my TDEE and more","date":"2023-08-02T00:00:00.000Z"},{"path":"/en/blog/coding/creating-a-startup-with-github-actions-and-google-forms/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDIyLTA5LTEzVDAwOjAwOjAwLjAwMFo=","title":"Creating a Startup with GitHub Actions and Google Forms","date":"2022-09-13T00:00:00.000Z"},{"path":"/en/blog/coding/how-to-get-the-redux-state-from-a-react-18-production-build-via-the-browsers-console/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDIyLTA4LTIxVDAwOjAwOjAwLjAwMFo=","title":"How to get the Redux State in a React 18 production build via the browser's console","date":"2022-08-21T00:00:00.000Z"},{"path":"/en/blog/coding/adding-a-copy-button-to-code-snippets-on-gatsby-the-lazy-way/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDIyLTA1LTA1VDAwOjAwOjAwLjAwMFo=","title":"Adding a copy button to code snippets on Gatsby: The lazy way","date":"2022-05-05T00:00:00.000Z"},{"path":"/en/blog/coding/how-webpack-handles-dynamic-imports-with-variable-paths/","postHashId":"Y29kaW5ndHJ1ZW51bGwyMDIyLTA0LTExVDAwOjAwOjAwLjAwMFo=","title":"How Webpack handles dynamic imports with variable paths","date":"2022-04-11T00:00:00.000Z"}]}